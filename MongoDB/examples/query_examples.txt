# MongoDB Query Examples

This file contains example MongoDB queries and operations for the Learning Module.
Use these in the MongoDB shell (mongosh) or in your Node.js code.

## Connection

# Connect to MongoDB
mongosh

# Use the learning database
use learning_db

# Show all databases
show dbs

# Show all collections
show collections

## Basic Queries

# Find all items
db.items.find()

# Find all items (pretty formatted)
db.items.find().pretty()

# Count all items
db.items.countDocuments()

# Find one item
db.items.findOne()

# Find by ObjectId
db.items.findOne({ _id: ObjectId("507f1f77bcf86cd799439011") })

## Filtering

# Find items by category
db.items.find({ category: "Electronics" })

# Find items by name
db.items.find({ name: "Laptop" })

# Find items with exact price
db.items.find({ price: 999.99 })

# Find items with price greater than 100
db.items.find({ price: { $gt: 100 } })

# Find items with price greater than or equal to 100
db.items.find({ price: { $gte: 100 } })

# Find items with price less than 1000
db.items.find({ price: { $lt: 1000 } })

# Find items with price less than or equal to 1000
db.items.find({ price: { $lte: 1000 } })

# Find items with price between 100 and 1000
db.items.find({ price: { $gte: 100, $lte: 1000 } })

# Find items NOT equal to a value
db.items.find({ category: { $ne: "Electronics" } })

# Find items in a list of values
db.items.find({ category: { $in: ["Electronics", "Books", "Toys"] } })

# Find items NOT in a list of values
db.items.find({ category: { $nin: ["Electronics", "Clothing"] } })

## Text Search

# Text search in name or description
db.items.find({ $text: { $search: "laptop" } })

# Text search with multiple words
db.items.find({ $text: { $search: "gaming laptop" } })

# Text search with exact phrase
db.items.find({ $text: { $search: "\"gaming laptop\"" } })

# Regex search (case-insensitive)
db.items.find({ name: { $regex: "laptop", $options: "i" } })

# Regex search with pattern
db.items.find({ name: { $regex: "^L" } })  // Starts with L

# Regex search for ends with
db.items.find({ name: { $regex: "top$" } })  // Ends with 'top'

## Logical Operators

# AND - Items in Electronics category with price > 500
db.items.find({
  $and: [
    { category: "Electronics" },
    { price: { $gt: 500 } }
  ]
})

# OR - Items in Electronics OR Books category
db.items.find({
  $or: [
    { category: "Electronics" },
    { category: "Books" }
  ]
})

# NOT - Items NOT in Electronics category
db.items.find({ category: { $not: { $eq: "Electronics" } } })

# NOR - Items not in Electronics and not in Books
db.items.find({
  $nor: [
    { category: "Electronics" },
    { category: "Books" }
  ]
})

# Complex query - (Electronics OR Books) AND price < 500
db.items.find({
  $and: [
    {
      $or: [
        { category: "Electronics" },
        { category: "Books" }
      ]
    },
    { price: { $lt: 500 } }
  ]
})

## Existence and Type Checks

# Items where description exists
db.items.find({ description: { $exists: true } })

# Items where description doesn't exist or is null
db.items.find({ description: { $exists: false } })

# Items where description is not null
db.items.find({ description: { $ne: null } })

# Items where price is a number
db.items.find({ price: { $type: "number" } })

# Items where price is a string (should be none if schema is correct)
db.items.find({ price: { $type: "string" } })

## Sorting

# Sort by name (ascending)
db.items.find().sort({ name: 1 })

# Sort by name (descending)
db.items.find().sort({ name: -1 })

# Sort by price (descending)
db.items.find().sort({ price: -1 })

# Sort by multiple fields
db.items.find().sort({ category: 1, price: -1 })

# Sort by created_at (newest first)
db.items.find().sort({ created_at: -1 })

## Limiting and Skipping

# Get first 5 items
db.items.find().limit(5)

# Skip first 10 items
db.items.find().skip(10)

# Pagination - page 2 with 10 items per page
db.items.find().skip(10).limit(10)

# Top 5 most expensive items
db.items.find().sort({ price: -1 }).limit(5)

## Projection (Select specific fields)

# Select only name and price
db.items.find({}, { name: 1, price: 1 })

# Select all except _id
db.items.find({}, { _id: 0 })

# Select name and price, exclude _id
db.items.find({}, { name: 1, price: 1, _id: 0 })

# Exclude specific fields
db.items.find({}, { description: 0, created_at: 0 })

## Aggregation Pipeline

# Count items by category
db.items.aggregate([
  { $group: { _id: "$category", count: { $sum: 1 } } }
])

# Average price by category
db.items.aggregate([
  { $group: { _id: "$category", avgPrice: { $avg: "$price" } } }
])

# Total value (price * quantity) by category
db.items.aggregate([
  {
    $group: {
      _id: "$category",
      totalValue: { $sum: { $multiply: ["$price", "$quantity"] } }
    }
  }
])

# Items with price > 100, grouped by category
db.items.aggregate([
  { $match: { price: { $gt: 100 } } },
  { $group: { _id: "$category", count: { $sum: 1 } } }
])

# Top 3 categories by total items
db.items.aggregate([
  { $group: { _id: "$category", count: { $sum: 1 } } },
  { $sort: { count: -1 } },
  { $limit: 3 }
])

# Statistics by category
db.items.aggregate([
  {
    $group: {
      _id: "$category",
      count: { $sum: 1 },
      avgPrice: { $avg: "$price" },
      minPrice: { $min: "$price" },
      maxPrice: { $max: "$price" },
      totalQuantity: { $sum: "$quantity" }
    }
  },
  { $sort: { avgPrice: -1 } }
])

# Items with price buckets
db.items.aggregate([
  {
    $bucket: {
      groupBy: "$price",
      boundaries: [0, 100, 500, 1000, 5000],
      default: "Other",
      output: {
        count: { $sum: 1 },
        items: { $push: "$name" }
      }
    }
  }
])

## Insert Operations

# Insert one item
db.items.insertOne({
  name: "Smartphone",
  description: "Latest model smartphone",
  category: "Electronics",
  price: 699.99,
  quantity: 25,
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString()
})

# Insert multiple items
db.items.insertMany([
  {
    name: "Laptop",
    description: "Gaming laptop",
    category: "Electronics",
    price: 1299.99,
    quantity: 10,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  },
  {
    name: "Book",
    description: "Programming guide",
    category: "Books",
    price: 49.99,
    quantity: 100,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  }
])

## Update Operations

# Update one item
db.items.updateOne(
  { name: "Laptop" },
  { $set: { price: 1199.99, updated_at: new Date().toISOString() } }
)

# Update by ObjectId
db.items.updateOne(
  { _id: ObjectId("507f1f77bcf86cd799439011") },
  { $set: { quantity: 15 } }
)

# Update multiple items
db.items.updateMany(
  { category: "Electronics" },
  { $set: { updated_at: new Date().toISOString() } }
)

# Increment quantity
db.items.updateOne(
  { name: "Laptop" },
  { $inc: { quantity: 5 } }
)

# Multiply price by factor
db.items.updateMany(
  { category: "Electronics" },
  { $mul: { price: 1.1 } }  // 10% increase
)

# Set minimum value
db.items.updateMany(
  {},
  { $max: { quantity: 0 } }  // Ensure quantity is at least 0
)

# Rename field
db.items.updateMany(
  {},
  { $rename: { "old_field": "new_field" } }
)

# Unset (remove) field
db.items.updateMany(
  {},
  { $unset: { obsolete_field: "" } }
)

## Delete Operations

# Delete one item
db.items.deleteOne({ name: "Test Item" })

# Delete by ObjectId
db.items.deleteOne({ _id: ObjectId("507f1f77bcf86cd799439011") })

# Delete multiple items
db.items.deleteMany({ category: "Obsolete" })

# Delete all items with price 0
db.items.deleteMany({ price: 0 })

# Delete all items (use with caution!)
db.items.deleteMany({})

## Indexes

# Show all indexes
db.items.getIndexes()

# Create index on category
db.items.createIndex({ category: 1 })

# Create index on name
db.items.createIndex({ name: 1 })

# Create compound index
db.items.createIndex({ category: 1, price: -1 })

# Create text index
db.items.createIndex({ name: "text", description: "text" })

# Create unique index
db.items.createIndex({ name: 1 }, { unique: true })

# Drop index
db.items.dropIndex("category_1")

# Drop all indexes except _id
db.items.dropIndexes()

## Collection Operations

# Get collection statistics
db.items.stats()

# Count documents
db.items.estimatedDocumentCount()  // Fast estimate
db.items.countDocuments()          // Accurate count

# Distinct values
db.items.distinct("category")

# Get distinct categories
db.items.distinct("category")

# Validate collection
db.items.validate()

## Backup and Restore

# Export collection to JSON (run in terminal, not mongosh)
mongoexport --db=learning_db --collection=items --out=items.json

# Export with query
mongoexport --db=learning_db --collection=items --query='{"category":"Electronics"}' --out=electronics.json

# Import collection from JSON
mongoimport --db=learning_db --collection=items --file=items.json

# Backup entire database
mongodump --db=learning_db --out=/backup/

# Restore database
mongorestore --db=learning_db /backup/learning_db/

## Useful Commands

# Show current database
db.getName()

# Show MongoDB version
db.version()

# Show server status
db.serverStatus()

# Show database statistics
db.stats()

# Drop collection (careful!)
db.items.drop()

# Drop database (very careful!)
db.dropDatabase()

# Create new collection with validation
db.createCollection("items", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["name", "price", "quantity"],
      properties: {
        name: {
          bsonType: "string",
          description: "must be a string and is required"
        },
        price: {
          bsonType: "number",
          minimum: 0,
          description: "must be a non-negative number"
        },
        quantity: {
          bsonType: "int",
          minimum: 0,
          description: "must be a non-negative integer"
        }
      }
    }
  }
})

## Performance

# Explain query plan
db.items.find({ category: "Electronics" }).explain("executionStats")

# Check if index is used
db.items.find({ category: "Electronics" }).explain()

# Get slow queries (enable profiling first)
db.setProfilingLevel(1, { slowms: 100 })
db.system.profile.find().pretty()

## Advanced Queries

# Find items updated in last 24 hours
db.items.find({
  updated_at: {
    $gte: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
  }
})

# Find items with array field containing value
db.items.find({ tags: "electronics" })

# Find items with array field containing all values
db.items.find({ tags: { $all: ["electronics", "new"] } })

# Find items where array size is 3
db.items.find({ tags: { $size: 3 } })

# Update array - add element
db.items.updateOne(
  { name: "Laptop" },
  { $push: { tags: "premium" } }
)

# Update array - remove element
db.items.updateOne(
  { name: "Laptop" },
  { $pull: { tags: "old" } }
)

# Update array - add unique element
db.items.updateOne(
  { name: "Laptop" },
  { $addToSet: { tags: "premium" } }
)

---

For more MongoDB query examples and documentation:
https://docs.mongodb.com/manual/reference/method/
