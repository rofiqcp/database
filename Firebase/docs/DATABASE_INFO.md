# Firebase Firestore Database Information

Comprehensive guide to the Firestore database structure, collections, indexes, and security rules.

## Database Overview

- **Type**: Cloud Firestore (NoSQL document database)
- **Provider**: Google Firebase
- **Collection**: `items`
- **Document ID**: Auto-generated by Firestore

## Collection Structure

### items Collection

Main collection storing all item documents.

**Collection Path:**
```
/items/{documentId}
```

## Document Schema

Each document in the `items` collection has the following structure:

```javascript
{
  id: string,              // Auto-generated document ID
  name: string,            // Item name (required)
  description: string,     // Item description (optional)
  price: number,           // Item price in dollars (default: 0)
  category: string,        // Item category (optional)
  stock: number,           // Available stock quantity (default: 0)
  featured: boolean,       // Featured item flag (default: false)
  userId: string,          // User identifier (default: "anonymous")
  createdAt: Timestamp,    // Document creation timestamp
  updatedAt: Timestamp     // Last update timestamp
}
```

### Field Details

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `id` | string | Yes (auto) | - | Firestore auto-generated document ID |
| `name` | string | Yes | - | Name of the item |
| `description` | string | No | "" | Detailed description of the item |
| `price` | number | No | 0 | Price in USD (supports decimals) |
| `category` | string | No | "" | Item category for filtering |
| `stock` | number | No | 0 | Available quantity in stock |
| `featured` | boolean | No | false | Whether item is featured |
| `userId` | string | No | "anonymous" | ID of user who created/owns the item |
| `createdAt` | Timestamp | Yes (auto) | server | Document creation timestamp |
| `updatedAt` | Timestamp | Yes (auto) | server | Last modification timestamp |

### Field Validation

**Backend validation rules:**

- `name`: Required, non-empty string
- `price`: Positive number (>= 0)
- `stock`: Non-negative integer (>= 0)
- `featured`: Boolean value
- `description`, `category`, `userId`: Strings (can be empty)

## Firestore Timestamps

Firestore uses server-side timestamps with the following structure:

```javascript
{
  "_seconds": 1234567890,
  "_nanoseconds": 123456789
}
```

**Converting to JavaScript Date:**
```javascript
// If timestamp has toDate() method (Firestore Timestamp object)
const date = timestamp.toDate();

// If timestamp is plain object with seconds
const date = new Date(timestamp._seconds * 1000);
```

## Indexes

Firestore automatically creates single-field indexes for all fields. Composite indexes must be created manually.

### Required Composite Indexes

#### 1. Category + CreatedAt Index

For efficient category-based queries sorted by creation date.

**Configuration:**
- Collection: `items`
- Fields:
  - `category` (Ascending)
  - `createdAt` (Descending)
- Query scope: Collection

**Used by queries:**
```javascript
db.collection('items')
  .where('category', '==', 'Electronics')
  .orderBy('createdAt', 'desc');
```

#### 2. Featured + CreatedAt Index (Optional)

For efficient featured items queries.

**Configuration:**
- Collection: `items`
- Fields:
  - `featured` (Ascending)
  - `createdAt` (Descending)
- Query scope: Collection

**Used by queries:**
```javascript
db.collection('items')
  .where('featured', '==', true)
  .orderBy('createdAt', 'desc');
```

### Creating Indexes

**Method 1: Firebase Console**
1. Go to Firestore Database → Indexes
2. Click "Create Index"
3. Configure fields and click "Create"

**Method 2: Automatic (Recommended)**
1. Run the query that requires the index
2. Firebase will provide an error with a link
3. Click the link to auto-create the index

**Method 3: Firebase CLI**

Create `firestore.indexes.json`:
```json
{
  "indexes": [
    {
      "collectionGroup": "items",
      "queryScope": "COLLECTION",
      "fields": [
        {"fieldPath": "category", "order": "ASCENDING"},
        {"fieldPath": "createdAt", "order": "DESCENDING"}
      ]
    },
    {
      "collectionGroup": "items",
      "queryScope": "COLLECTION",
      "fields": [
        {"fieldPath": "featured", "order": "ASCENDING"},
        {"fieldPath": "createdAt", "order": "DESCENDING"}
      ]
    }
  ]
}
```

Deploy:
```bash
firebase deploy --only firestore:indexes
```

## Security Rules

Firestore Security Rules control access to your data.

### Development Rules (Test Mode)

**⚠️ Warning: These rules allow all reads and writes. Use only for development!**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /items/{itemId} {
      allow read, write: if true;
    }
  }
}
```

### Production Rules (Recommended)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /items/{itemId} {
      // Allow anyone to read items
      allow read: if true;
      
      // Allow authenticated users to create items
      allow create: if request.auth != null
                    && request.resource.data.keys().hasAll(['name', 'createdAt', 'updatedAt'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.price >= 0
                    && request.resource.data.stock >= 0;
      
      // Allow item owner or admin to update
      allow update: if request.auth != null
                    && (request.auth.uid == resource.data.userId 
                        || request.auth.token.admin == true)
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.price >= 0
                    && request.resource.data.stock >= 0;
      
      // Allow item owner or admin to delete
      allow delete: if request.auth != null
                    && (request.auth.uid == resource.data.userId 
                        || request.auth.token.admin == true);
    }
  }
}
```

### Security Rules Explanation

**Read Rules:**
- Public read access (anyone can view items)

**Create Rules:**
- User must be authenticated
- Required fields: `name`, `createdAt`, `updatedAt`
- `name` must be non-empty string
- `price` and `stock` must be non-negative

**Update Rules:**
- User must be authenticated
- User must be the item owner OR an admin
- Field validation same as create

**Delete Rules:**
- User must be authenticated
- User must be the item owner OR an admin

### Testing Security Rules

**Firebase Console:**
1. Go to Firestore Database → Rules
2. Click "Rules Playground"
3. Simulate operations

**Firebase Emulator:**
```bash
firebase emulators:start --only firestore
```

## Query Patterns

### Common Queries

**Get all items:**
```javascript
const snapshot = await db.collection('items')
  .orderBy('createdAt', 'desc')
  .get();
```

**Get item by ID:**
```javascript
const doc = await db.collection('items')
  .doc('abc123')
  .get();
```

**Get items by category:**
```javascript
const snapshot = await db.collection('items')
  .where('category', '==', 'Electronics')
  .orderBy('createdAt', 'desc')
  .get();
```

**Get featured items:**
```javascript
const snapshot = await db.collection('items')
  .where('featured', '==', true)
  .orderBy('createdAt', 'desc')
  .get();
```

**Get items in price range:**
```javascript
const snapshot = await db.collection('items')
  .where('price', '>=', 100)
  .where('price', '<=', 500)
  .orderBy('price', 'asc')
  .get();
```

**Pagination:**
```javascript
const first = await db.collection('items')
  .orderBy('createdAt', 'desc')
  .limit(10)
  .get();

const lastDoc = first.docs[first.docs.length - 1];

const next = await db.collection('items')
  .orderBy('createdAt', 'desc')
  .startAfter(lastDoc)
  .limit(10)
  .get();
```

### Real-time Listeners

**Listen to all items:**
```javascript
const unsubscribe = db.collection('items')
  .orderBy('createdAt', 'desc')
  .onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === 'added') {
        console.log('New item:', change.doc.data());
      }
      if (change.type === 'modified') {
        console.log('Modified item:', change.doc.data());
      }
      if (change.type === 'removed') {
        console.log('Removed item:', change.doc.data());
      }
    });
  });

// Later: unsubscribe();
```

**Listen to single document:**
```javascript
const unsubscribe = db.collection('items')
  .doc('abc123')
  .onSnapshot((doc) => {
    if (doc.exists) {
      console.log('Item data:', doc.data());
    }
  });
```

## Performance Considerations

### Best Practices

1. **Use indexes**: Create composite indexes for complex queries
2. **Limit results**: Use `.limit()` to avoid large reads
3. **Pagination**: Implement cursor-based pagination for large datasets
4. **Avoid negation**: `!=` queries require composite indexes
5. **Minimize reads**: Use real-time listeners instead of polling
6. **Batch operations**: Use batched writes for multiple documents

### Query Limitations

- Maximum 10 inequality filters per query
- Cannot use `!=` and `in` on different fields
- Array-contains queries limited to one per query
- Maximum 500 results per query (use pagination)

## Backup and Restore

### Automated Backups (Firebase Console)

1. Go to Firestore Database → Backups
2. Enable automated backups
3. Choose schedule and retention

### Manual Export

Using Firebase CLI:
```bash
gcloud firestore export gs://bucket-name/path
```

### Manual Import

```bash
gcloud firestore import gs://bucket-name/path
```

## Monitoring

### Firebase Console Metrics

- **Usage tab**: Read/write operations, storage
- **Indexes tab**: Index status and builds
- **Rules tab**: Rules evaluation metrics

### Cloud Monitoring

Set up alerts for:
- High read/write counts
- Error rates
- Slow queries

## Pricing

**Free Tier (Spark Plan):**
- 50,000 reads/day
- 20,000 writes/day
- 20,000 deletes/day
- 1 GiB storage

**Paid Tier (Blaze Plan):**
- $0.06 per 100,000 reads
- $0.18 per 100,000 writes
- $0.02 per 100,000 deletes
- $0.18/GiB/month storage

## Additional Resources

- [Firestore Data Model](https://firebase.google.com/docs/firestore/data-model)
- [Firestore Queries](https://firebase.google.com/docs/firestore/query-data/queries)
- [Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Best Practices](https://firebase.google.com/docs/firestore/best-practices)
