# Cassandra CQL Query Examples

This file contains example CQL queries and operations for the Learning Module.
Use these in the CQL shell (cqlsh) or in your Node.js code.

## Connection

# Connect to Cassandra
cqlsh

# Use the learning keyspace
USE learning_db;

# Show all keyspaces
DESCRIBE KEYSPACES;

# Show all tables in current keyspace
DESCRIBE TABLES;

## Basic Queries

# Find all items
SELECT * FROM items;

# Count all items
SELECT COUNT(*) FROM items;

# Find by primary key (UUID)
SELECT * FROM items WHERE id = 550e8400-e29b-41d4-a716-446655440000;

# Select specific columns
SELECT name, price, quantity FROM items;

## Filtering with Secondary Index

# Find items by category (uses secondary index)
SELECT * FROM items WHERE category = 'Electronics';

# Find items by category
SELECT * FROM items WHERE category = 'Books';

# Find items by category
SELECT * FROM items WHERE category = 'Furniture';

## Filtering with ALLOW FILTERING

# Note: ALLOW FILTERING should be used carefully in production
# It can cause full table scans

# Find items with specific name
SELECT * FROM items WHERE name = 'Laptop' ALLOW FILTERING;

# Find items with specific quantity
SELECT * FROM items WHERE quantity > 10 ALLOW FILTERING;

## Insert Operations

# Insert one item with generated UUID
INSERT INTO items (id, name, description, category, price, quantity, created_at, updated_at)
VALUES (uuid(), 'Smartphone', 'Latest model smartphone', 'Electronics', 699.99, 25, toTimestamp(now()), toTimestamp(now()));

# Insert with specific UUID
INSERT INTO items (id, name, description, category, price, quantity, created_at, updated_at)
VALUES (550e8400-e29b-41d4-a716-446655440099, 'Tablet', 'Android tablet 10 inch', 'Electronics', 399.99, 15, toTimestamp(now()), toTimestamp(now()));

# Insert multiple items (batch)
BEGIN BATCH
  INSERT INTO items (id, name, description, category, price, quantity, created_at, updated_at)
  VALUES (uuid(), 'Laptop', 'Gaming laptop', 'Electronics', 1299.99, 10, toTimestamp(now()), toTimestamp(now()));
  INSERT INTO items (id, name, description, category, price, quantity, created_at, updated_at)
  VALUES (uuid(), 'Book', 'Programming guide', 'Books', 49.99, 100, toTimestamp(now()), toTimestamp(now()));
APPLY BATCH;

## Update Operations

# Update one item by UUID
UPDATE items SET price = 1199.99, updated_at = toTimestamp(now())
WHERE id = 550e8400-e29b-41d4-a716-446655440000;

# Update multiple fields
UPDATE items SET name = 'Gaming Laptop', description = 'Updated description', quantity = 15, updated_at = toTimestamp(now())
WHERE id = 550e8400-e29b-41d4-a716-446655440000;

## Delete Operations

# Delete one item by UUID
DELETE FROM items WHERE id = 550e8400-e29b-41d4-a716-446655440000;

# Delete all items (truncate table)
TRUNCATE items;

## TTL (Time-to-Live)

# Insert with TTL (auto-delete after 86400 seconds = 24 hours)
INSERT INTO items (id, name, description, category, price, quantity, created_at, updated_at)
VALUES (uuid(), 'Flash Sale Item', 'Limited time offer', 'Sale', 9.99, 5, toTimestamp(now()), toTimestamp(now()))
USING TTL 86400;

# Update with TTL
UPDATE items USING TTL 3600
SET description = 'Expires in 1 hour'
WHERE id = 550e8400-e29b-41d4-a716-446655440000;

# Check remaining TTL
SELECT TTL(description) FROM items WHERE id = 550e8400-e29b-41d4-a716-446655440000;

## Lightweight Transactions (LWT)

# Insert if not exists (conditional insert)
INSERT INTO items (id, name, description, category, price, quantity, created_at, updated_at)
VALUES (550e8400-e29b-41d4-a716-446655440000, 'Unique Item', 'Only one', 'Special', 999.99, 1, toTimestamp(now()), toTimestamp(now()))
IF NOT EXISTS;

# Update only if current value matches (compare-and-set)
UPDATE items SET price = 899.99
WHERE id = 550e8400-e29b-41d4-a716-446655440000
IF price = 999.99;

## Schema Operations

# Describe table structure
DESCRIBE TABLE items;

# Show table creation CQL
DESCRIBE TABLE items;

# Add a new column
ALTER TABLE items ADD tags set<text>;

# Drop a column
ALTER TABLE items DROP tags;

# Create secondary index
CREATE INDEX IF NOT EXISTS idx_items_category ON items (category);

# Drop index
DROP INDEX IF EXISTS idx_items_category;

## Keyspace Operations

# Create keyspace with SimpleStrategy
CREATE KEYSPACE IF NOT EXISTS learning_db
WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 1};

# Create keyspace with NetworkTopologyStrategy (production)
CREATE KEYSPACE IF NOT EXISTS prod_db
WITH replication = {'class': 'NetworkTopologyStrategy', 'dc1': 3, 'dc2': 2};

# Alter keyspace replication
ALTER KEYSPACE learning_db
WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 3};

# Drop keyspace (careful!)
DROP KEYSPACE IF EXISTS test_keyspace;

## Table Design Examples

# Time-series data table (common Cassandra pattern)
CREATE TABLE IF NOT EXISTS sensor_data (
  sensor_id uuid,
  reading_time timestamp,
  value double,
  unit text,
  PRIMARY KEY (sensor_id, reading_time)
) WITH CLUSTERING ORDER BY (reading_time DESC);

# Insert sensor data
INSERT INTO sensor_data (sensor_id, reading_time, value, unit)
VALUES (uuid(), toTimestamp(now()), 23.5, 'celsius');

# Query sensor data (sorted by time)
SELECT * FROM sensor_data WHERE sensor_id = 550e8400-e29b-41d4-a716-446655440000;

# User activity log (compound partition key)
CREATE TABLE IF NOT EXISTS user_activity (
  user_id uuid,
  activity_date date,
  activity_time timestamp,
  action text,
  details text,
  PRIMARY KEY ((user_id, activity_date), activity_time)
) WITH CLUSTERING ORDER BY (activity_time DESC);

## Collections (Lists, Sets, Maps)

# Table with collections
CREATE TABLE IF NOT EXISTS products (
  id uuid PRIMARY KEY,
  name text,
  tags set<text>,
  ratings list<int>,
  attributes map<text, text>
);

# Insert with collections
INSERT INTO products (id, name, tags, ratings, attributes)
VALUES (uuid(), 'Laptop', {'electronics', 'computing'}, [5, 4, 5], {'color': 'silver', 'brand': 'Dell'});

# Add to set
UPDATE products SET tags = tags + {'portable'} WHERE id = 550e8400-e29b-41d4-a716-446655440000;

# Remove from set
UPDATE products SET tags = tags - {'portable'} WHERE id = 550e8400-e29b-41d4-a716-446655440000;

# Append to list
UPDATE products SET ratings = ratings + [3] WHERE id = 550e8400-e29b-41d4-a716-446655440000;

# Add to map
UPDATE products SET attributes['weight'] = '2.5kg' WHERE id = 550e8400-e29b-41d4-a716-446655440000;

## Aggregation Functions

# Count items
SELECT COUNT(*) FROM items;

# Min and max price
SELECT MIN(price), MAX(price) FROM items;

# Sum of quantities
SELECT SUM(quantity) FROM items;

# Average price
SELECT AVG(price) FROM items;

# Count by category (requires ALLOW FILTERING or materialized view)
SELECT category, COUNT(*) FROM items GROUP BY category ALLOW FILTERING;

## Materialized Views

# Create materialized view for items by category
CREATE MATERIALIZED VIEW IF NOT EXISTS items_by_category AS
SELECT * FROM items
WHERE category IS NOT NULL AND id IS NOT NULL
PRIMARY KEY (category, id);

# Query the materialized view (no ALLOW FILTERING needed)
SELECT * FROM items_by_category WHERE category = 'Electronics';

# Drop materialized view
DROP MATERIALIZED VIEW IF EXISTS items_by_category;

## Performance and Diagnostics

# Enable tracing for a query
TRACING ON;
SELECT * FROM items WHERE id = 550e8400-e29b-41d4-a716-446655440000;
TRACING OFF;

# Check consistency level
CONSISTENCY;

# Set consistency level
CONSISTENCY ONE;
CONSISTENCY QUORUM;
CONSISTENCY ALL;

## Backup and Export

# Copy table data to CSV file (run in cqlsh)
COPY items TO '/tmp/items_backup.csv' WITH HEADER = TRUE;

# Import data from CSV file
COPY items FROM '/tmp/items_backup.csv' WITH HEADER = TRUE;

# Copy with specific columns
COPY items (id, name, price) TO '/tmp/items_partial.csv' WITH HEADER = TRUE;

## Useful cqlsh Commands

# Show current keyspace
SELECT * FROM system_schema.keyspaces WHERE keyspace_name = 'learning_db';

# Show Cassandra version
SHOW VERSION;

# Show host info
SHOW HOST;

# Clear screen
CLEAR;

# Execute CQL from file
SOURCE '/path/to/script.cql';

# Set page size for large results
PAGING ON;
PAGING 100;

## Node.js Driver Examples

# These are JavaScript examples for use with cassandra-driver

/*
// Connect to Cassandra
const cassandra = require('cassandra-driver');
const client = new cassandra.Client({
  contactPoints: ['localhost'],
  localDataCenter: 'datacenter1',
  keyspace: 'learning_db'
});

// Execute query with prepared statement
const query = 'SELECT * FROM items WHERE id = ?';
const result = await client.execute(query, [id], { prepare: true });

// Insert with UUID
const { v4: uuidv4 } = require('uuid');
const id = cassandra.types.Uuid.fromString(uuidv4());
await client.execute(
  'INSERT INTO items (id, name, price) VALUES (?, ?, ?)',
  [id, 'New Item', new cassandra.types.BigDecimal.fromString('99.99')],
  { prepare: true }
);

// Batch operations
const queries = [
  { query: 'INSERT INTO items (id, name) VALUES (?, ?)', params: [cassandra.types.Uuid.random(), 'Item1'] },
  { query: 'INSERT INTO items (id, name) VALUES (?, ?)', params: [cassandra.types.Uuid.random(), 'Item2'] }
];
await client.batch(queries, { prepare: true });

// Shutdown
await client.shutdown();
*/

---

For more CQL query examples and documentation:
https://cassandra.apache.org/doc/latest/cql/
https://docs.datastax.com/en/cql-oss/3.x/cql/cql_reference/cqlReferenceTOC.html
